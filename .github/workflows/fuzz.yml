name: Fuzz (property-based)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  fuzz:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm run build
      - name: Run fuzz tests (shard ${{ matrix.shard }})
        run: |
          # Vitest's internal birpc has a hardcoded 60s RPC timeout. Long-running
          # property tests (>60s) trigger "Timeout calling onTaskUpdate" unhandled
          # errors that cause exit code 1 even when all tests pass. Work around
          # this by checking the actual test results via --reporter=json.
          set +e
          npx vitest run --reporter=json --reporter=default 2>stderr.log | tee stdout.log
          exit_code=$?
          set -e

          if [ $exit_code -eq 0 ]; then
            exit 0
          fi

          # Extract JSON block from stdout (vitest outputs JSON after the default report)
          if python3 -c "
          import json, sys
          data = json.loads(sys.stdin.read().split('\n')[-2])
          failed = data.get('numFailedTests', 1)
          sys.exit(0 if failed == 0 else 1)
          " < stdout.log 2>/dev/null; then
            echo "::warning::All tests passed but vitest exited $exit_code (likely birpc RPC timeout). Treating as success."
            exit 0
          fi

          # Real test failure
          cat stderr.log >&2
          exit $exit_code
        env:
          FC_NUM_RUNS: 25000
          VITEST_TIMEOUT: 120000
      - if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: regressions-shard-${{ matrix.shard }}
          path: |
            packages/core/src/__tests__/regressions/
            packages/web/src/__tests__/regressions/

  report:
    runs-on: ubuntu-latest
    needs: fuzz
    if: failure()
    permissions:
      issues: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: regressions-shard-*
          merge-multiple: true
      - uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const dirs = [
              'packages/core/src/__tests__/regressions',
              'packages/web/src/__tests__/regressions',
            ];
            let body = `Scheduled fuzz run failed.\n\n`;
            body += `**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n`;
            for (const dir of dirs) {
              if (!fs.existsSync(dir)) continue;
              for (const file of fs.readdirSync(dir)) {
                const content = JSON.parse(fs.readFileSync(`${dir}/${file}`, 'utf-8'));
                if (Object.keys(content).length > 0) {
                  body += `### ${file}\n\`\`\`json\n${JSON.stringify(content, null, 2)}\n\`\`\`\n\n`;
                }
              }
            }
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Fuzz failure: ${new Date().toISOString().slice(0, 10)}`,
              body,
              labels: ['bug', 'fuzz'],
            });
